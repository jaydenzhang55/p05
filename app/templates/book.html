<!--
Jayden Zhang, Margie Cao, Danny Huang, Kyle Lee
404NotFound
SoftDev
P04
Time spent: tbd
Target Ship Date: 2025-06-06
-->

<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
    <style>
        #pdf-render {
            border: 1px solid #ddd;
            max-width: 100%;
            height: auto;
            margin: 20px auto;
            display: block;
            box-shadow: 0 0 10px #aaa;
        }
    </style>
    <title>Display PDF</title>
    <script src="../static/js/main.js"></script>
    {% block javascript %}
    <script>
        var loggedIn = {{ loggedIn | tojson }}; 
        var user = loggedIn ? {{ username | tojson }} : null;
    </script>
    {% endblock %}
</head>


<body class="bg-white text-black font-sans">
    <nav class="flex flex-row justify-between items-center h-20 w-full bg-white border border-b-gray-300 shadow-md">
        <a href="/"><h1 class=" basis-7/24 peer-has-[:focus]:basis-5/24 order-first ml-10 text-blue-700 text-4xl font-bold">Î¾</h1></a>
        <ul id="navItem"
            class="basis-5/12 peer-has-[:focus]:basis-6/12 flex flex-row justify-evenly justify-center-safe h-full text-center items-center text-xl">
            <li
                class="flex flex-row basis-1/2 items-center justify-center peer w-full has-[:focus]:basis-3/4 ease-in-out">
                <form method="POST" action="/search" id='searchBar' class="peer has-[:focus]:w-full">
                    <input class="border border-solid w-full p-2 text-blue-800 rounded-md" type="text" id="search"
                        name="search" placeholder="Search">
                </form>
            </li>
            <li class="basis-1/10 hover:border-b-4 hover:border-b-blue-500 hover:text-blue-700 ml-2">
                <a href="/upload" class="px-4 py-2">Upload</a>
            </li>
            <li class="basis-1/10 hover:border-b-4 hover:border-b-blue-500 hover:text-blue-700 ml-2">
                <a href="/tos" class="px-4 py-2">TOS</a>
            </li>
            <li class="basis-1/10 hover:border-b-4 hover:border-b-blue-500 hover:text-blue-700 ml-2">
                <a href="/saved/{{username}}" class="px-4 py-2" id="sbutton">Saved</a>
            </li>
        </ul>
        <ul class="basis-7/24 flex flex-row-reverse order last h-full text-center items-center text-xl">
            <li class="flex items-center px-4">
                <a href="/login"
                    class="px-4 py-2 rounded-3xl transition bg-blue-600 text-white hover:bg-blue-500 hover:scale-105"
                    id="loginButton">Log In</a>
            </li>
            <li class="flex items-center">
                <a id='lmessage' class="px-4 py-2"></a>
            </li>
        </ul>
    </nav>
    <div class="flex flex-row w-full px-5 py-10">
        <div id="pdf-container" class="items-center justify-center w-1/2 overflow-auto max-h-screen border border-2 border-black p-5 rounded-lg"></div>
    </div>

    <script>
    const pdfB64 = `{{ pdf_b64 | safe }}`;

    if (!pdfB64) {
        document.getElementById('pdf-container').insertAdjacentText('beforebegin', "No PDF data available.");
    } else {
        function base64ToUint8Array(base64) {
            const raw = atob(base64);
            const uint8Array = new Uint8Array(raw.length);
            for (let i = 0; i < raw.length; i++) {
                uint8Array[i] = raw.charCodeAt(i);
            }
            return uint8Array;
        }

        const pdfData = base64ToUint8Array(pdfB64);
        const container = document.getElementById('pdf-container');

        pdfjsLib.getDocument({ data: pdfData }).promise.then(function (pdfDoc) {
            const numPages = pdfDoc.numPages;

            for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                pdfDoc.getPage(pageNum).then(function (page) {
                    const scale = 1.45;
                    const viewport = page.getViewport({ scale: scale });

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    canvas.setAttribute('class', 'b-b-2 border')

                    container.appendChild(canvas);

                    const renderContext = {
                        canvasContext: ctx,
                        viewport: viewport
                    };
                    page.render(renderContext);
                });
            }
        }).catch(function (error) {
            console.error('Error loading PDF:', error);
            document.getElementById('pdf-container').insertAdjacentText('beforebegin', "Failed to load PDF.");
        });
    }
    </script>
</body>

</html>
